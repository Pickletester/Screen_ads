<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>TB1 Synced Ads</title>

  <style>
    html, body{
      margin:0; padding:0;
      width:100vw; height:100vh;
      overflow:hidden;
      background:#000;
      font-family: Arial, Helvetica, sans-serif;
    }

    /* Full window */
    #container{
      position:fixed;
      inset:0;
      background:#000;
      overflow:hidden;
    }

    /* Two layers for crossfade */
    .layer{
      position:absolute;
      inset:0;
      opacity:0;
      transition: opacity 200ms linear; /* reduce flash */
      background:#000;
    }
    .layer.show{ opacity:1; }

    .layer img, .layer video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: fill;
      background:#000;
      display:block;
    }

    /* Error overlay (only shows if something fails) */
    #debug{
      position:absolute; inset:0;
      background: rgba(120,0,0,0.88);
      color:#fff;
      padding: 12px;
      box-sizing: border-box;
      font-size: 14px;
      white-space: pre-wrap;
      overflow:auto;
      display:none;
      z-index:999;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="layerA" class="layer"></div>
    <div id="layerB" class="layer"></div>
    <div id="debug">Startingâ€¦</div>
  </div>

  <script>
    // =============================
    // Absolute URL helper (TB1-safe)
    // =============================
    function baseDir() {
      var href = window.location.href.split("#")[0].split("?")[0];
      if (href.charAt(href.length - 1) === "/") return href;
      return href.substring(0, href.lastIndexOf("/") + 1);
    }
    var BASE = baseDir();

    function absUrl(u){
      // if already absolute, keep it
      if (/^https?:\/\//i.test(u)) return u;
      return BASE + u;
    }

    // =============================
    // DOM
    // =============================
    var A = document.getElementById("layerA");
    var B = document.getElementById("layerB");
    var debug = document.getElementById("debug");

    var front = A, back = B;

    function swapLayers(){
      var tmp = front; front = back; back = tmp;
    }

    function showError(msg){
      try { console.log(msg); } catch(e){}
      debug.style.display = "block";
      debug.textContent = msg;
    }
    function clearError(){
      debug.style.display = "none";
      debug.textContent = "";
    }

    // =============================
    // PLAYLIST (no fetch, no refresh)
    // =============================
    var playlist = [
      { type:"image", url:"Applebox.jpg",            duration:10 },
      { type:"image", url:"Comcast.jpg",             duration:10 },
      { type:"image", url:"Feet_DR.jpg",             duration:10 },
      { type:"image", url:"Howard_Hannah.jpg",       duration:10 },
      { type:"image", url:"Itaily.jpg",              duration:10 },
      { type:"image", url:"J_Frances2.jpg",          duration:10 },
      { type:"image", url:"Lorenzi.jpg",             duration:10 },
      { type:"image", url:"Mission.jpg",             duration:10 },
      { type:"image", url:"Pickleball_lifeline.jpg", duration:10 },
      { type:"image", url:"Sun_Chevy.jpg",           duration:10 },
      { type:"image", url:"ad1.jpg",                 duration:10 },
      { type:"video", url:"Screen_2_1.mp4",          duration:15 } // MUST match real length
    ];

    // =============================
    // SYNC
    // =============================
    function getParam(name){
      var q = window.location.search || "";
      q = q.replace(/^\?/, "");
      var parts = q.split("&");
      for (var i=0;i<parts.length;i++){
        var kv = parts[i].split("=");
        if (decodeURIComponent(kv[0]||"") === name) return decodeURIComponent(kv[1]||"");
      }
      return "";
    }
    var OFFSET = parseInt(getParam("offset") || "0", 10);
    if (isNaN(OFFSET)) OFFSET = 0;

    function nowSec(){ return Math.floor(Date.now()/1000) + OFFSET; }
    function loopLen(){
      var sum = 0;
      for (var i=0;i<playlist.length;i++) sum += playlist[i].duration;
      return sum;
    }

    function getSynced(){
      var L = loopLen();
      var t = ((nowSec() % L) + L) % L;
      var acc = 0;

      for (var i=0;i<playlist.length;i++){
        var d = playlist[i].duration;
        if (t < acc + d){
          return { index:i, elapsed:(t-acc), remaining:(acc+d)-t };
        }
        acc += d;
      }
      return { index:0, elapsed:0, remaining:playlist[0].duration };
    }

    // =============================
    // CROSSFADE PLAYER
    // =============================
    var timer = null;
    var safety = null;

    function clearTimers(){
      if (timer) { clearTimeout(timer); timer = null; }
      if (safety) { clearTimeout(safety); safety = null; }
    }

    function crossfadeToBack(){
      // show back, then hide old front
      back.className = "layer show";
      front.className = "layer";
      swapLayers();
    }

    function buildMedia(item, onReady, onFail){
      // only clear BACK layer (front stays visible)
      back.innerHTML = "";
      clearError();

      if (item.type === "image"){
        var img = document.createElement("img");
        img.onload = function(){ onReady(img); };
        img.onerror = function(){ onFail("Image failed: " + item.url); };
        img.src = absUrl(item.url);
        return;
      }

      if (item.type === "video"){
        var vid = document.createElement("video");
        vid.muted = true;
        vid.playsInline = true;
        vid.autoplay = false;
        vid.preload = "auto";

        // Some TB1 builds behave better when we wait for canplay
        var readyFired = false;

        vid.onloadedmetadata = function(){
          if (!readyFired) { readyFired = true; onReady(vid); }
        };
        vid.oncanplay = function(){
          if (!readyFired) { readyFired = true; onReady(vid); }
        };
        vid.onerror = function(){
          onFail("Video failed: " + item.url);
        };

        vid.src = absUrl(item.url);
        return;
      }

      onFail("Unknown type: " + item.type);
    }

    function playFrom(index, elapsed, remaining){
      clearTimers();

      var item = playlist[index];

      buildMedia(item, function(media){
        back.appendChild(media);

        if (item.type === "video"){
          // seek synced position after metadata/canplay
          var startAt = elapsed;
          if (startAt < 0) startAt = 0;
          if (startAt > item.duration - 0.1) startAt = item.duration - 0.1;

          try { media.currentTime = startAt; } catch(e){}

          // Force play (TB1 often needs explicit play)
          try {
            var p = media.play();
            if (p && p.catch) p.catch(function(){});
          } catch(e){}
        }

        // Fade only after next media is ready (prevents black flash)
        crossfadeToBack();

        // Next
        var nextIndex = (index + 1) % playlist.length;

        // Use timer (more reliable than onended on TB1)
        timer = setTimeout(function(){
          playFrom(nextIndex, 0, playlist[nextIndex].duration);
        }, Math.max(250, remaining * 1000));

        // Safety for TB1 video quirks
        if (item.type === "video"){
          safety = setTimeout(function(){
            playFrom(nextIndex, 0, playlist[nextIndex].duration);
          }, Math.max(750, remaining * 1000 + 500));
        }

      }, function(errMsg){
        showError(errMsg + "\n\nCheck GitHub filenames (case-sensitive) and that files are in the same folder as this HTML.");
        var nextIndex = (index + 1) % playlist.length;
        timer = setTimeout(function(){
          playFrom(nextIndex, 0, playlist[nextIndex].duration);
        }, 1500);
      });
    }

    function start(){
      var s = getSynced();
      playFrom(s.index, s.elapsed, s.remaining);
    }

    start();
  </script>
</body>
</html>
