<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>TB1 Ads Synced</title>

  <style>
    html, body {
      margin:0; padding:0;
      width:100vw; height:100vh;
      overflow:hidden;
      background:#000;
    }

    #stage { position:fixed; inset:0; background:#000; }

    /* Your “design size” (set to your mapped output for best results) */
    #canvas {
      position:absolute;
      left:50%; top:50%;
      width:864px;   /* CHANGE if needed */
      height:384px;  /* CHANGE if needed */
      transform: translate(-50%, -50%) scale(1);
      transform-origin:center center;
      background:#000;
    }

    .layer {
      position:absolute; inset:0;
      opacity:0;
      background:#000;
      transition: opacity 200ms linear;
    }
    .show { opacity:1; }

    .layer img, .layer video {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: fill;
      background:#000;
      display:block;
    }

    #debug {
      position:absolute; inset:0;
      display:none;
      background: rgba(120,0,0,0.88);
      color:#fff;
      padding:10px;
      box-sizing:border-box;
      white-space:pre-wrap;
      overflow:auto;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      z-index:999;
    }
  </style>
</head>

<body>
  <div id="stage">
    <div id="canvas">
      <div id="layerA" class="layer"></div>
      <div id="layerB" class="layer"></div>
      <div id="debug"></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    var DESIGN_W = 864;  // set to your actual mapped output width (maybe 864)
    var DESIGN_H = 384;  // set to your actual mapped output height (maybe 384)

    // Optional per-device offset tuning:
    // add ?offset=1 or ?offset=-2 to the URL if a TB1 clock is slightly off
    function getParam(name) {
      var q = window.location.search || "";
      q = q.replace(/^\?/, "");
      var parts = q.split("&");
      for (var i=0;i<parts.length;i++){
        var kv = parts[i].split("=");
        if (decodeURIComponent(kv[0] || "") === name) return decodeURIComponent(kv[1] || "");
      }
      return "";
    }
    var CLOCK_OFFSET_SEC = parseInt(getParam("offset") || "0", 10);
    if (isNaN(CLOCK_OFFSET_SEC)) CLOCK_OFFSET_SEC = 0;

    // =========================
    // PLAYLIST (NO FETCH, NO API, NO PAGE REFRESH)
    // =========================
    var playlist = [
      { type:"image", url:"Applebox.jpg",           duration:10 },
      { type:"image", url:"Comcast.jpg",            duration:10 },
      { type:"image", url:"Feet_DR.jpg",            duration:10 },
      { type:"image", url:"Howard_Hannah.jpg",      duration:10 },
      { type:"image", url:"Itaily.jpg",             duration:10 },
      { type:"image", url:"J_Frances2.jpg",         duration:10 },
      { type:"image", url:"Lorenzi.jpg",            duration:10 },
      { type:"image", url:"Mission.jpg",            duration:10 },
      { type:"image", url:"Pickleball_lifeline.jpg",duration:10 },
      { type:"image", url:"Sun_Chevy.jpg",          duration:10 },
      { type:"image", url:"ad1.jpg",                duration:10 },
      { type:"video", url:"Screen_2_1.mp4",         duration:15 }  // MUST match real length
    ];

    // =========================
    // HELPERS
    // =========================
    var canvas = document.getElementById("canvas");
    var layerA = document.getElementById("layerA");
    var layerB = document.getElementById("layerB");
    var debug  = document.getElementById("debug");

    var front = layerA;
    var back  = layerB;

    var timer = null;
    var safety = null;

    function showError(msg) {
      try { console.log(msg); } catch(e){}
      debug.style.display = "block";
      debug.textContent = msg;
    }
    function clearError() {
      debug.style.display = "none";
      debug.textContent = "";
    }

    function clearTimers() {
      if (timer) { clearTimeout(timer); timer = null; }
      if (safety) { clearTimeout(safety); safety = null; }
    }

    function nowSec() {
      return Math.floor(new Date().getTime() / 1000) + CLOCK_OFFSET_SEC;
    }

    function loopSeconds() {
      var total = 0;
      for (var i=0;i<playlist.length;i++) total += playlist[i].duration;
      return total;
    }

    function syncedPosition() {
      var L = loopSeconds();
      var t = nowSec() % L;
      if (t < 0) t += L;

      var acc = 0;
      for (var i=0;i<playlist.length;i++){
        var d = playlist[i].duration;
        if (t < acc + d) {
          return { index:i, elapsed:(t-acc), remaining:(acc+d)-t };
        }
        acc += d;
      }
      return { index:0, elapsed:0, remaining:playlist[0].duration };
    }

    // Build an absolute URL that works on GitHub Pages project sites
    function baseDir() {
      // e.g. https://pickletester.github.io/Screen_ads/index.html -> /Screen_ads/
      var href = window.location.href;
      href = href.split("#")[0].split("?")[0];
      if (href.slice(-1) === "/") return href;
      return href.substring(0, href.lastIndexOf("/") + 1);
    }
    var BASE = baseDir();

    function fitToScreen() {
      var vw = window.innerWidth || document.documentElement.clientWidth || DESIGN_W;
      var vh = window.innerHeight || document.documentElement.clientHeight || DESIGN_H;
      var scale = Math.min(vw / DESIGN_W, vh / DESIGN_H);

      canvas.style.width  = DESIGN_W + "px";
      canvas.style.height = DESIGN_H + "px";
      canvas.style.transform = "translate(-50%, -50%) scale(" + scale + ")";
    }
    window.onresize = fitToScreen;
    fitToScreen();

    function swapLayers() {
      var tmp = front;
      front = back;
      back = tmp;
    }

    function crossfade() {
      back.className = "layer show";
      front.className = "layer";
      swapLayers();
    }

    function clearBack() {
      back.innerHTML = "";
      back.className = "layer";
    }

    function playAt(index, elapsed, remaining) {
      clearTimers();

      var item = playlist[index];
      var nextIndex = (index + 1) % playlist.length;

      clearError();
      clearBack();

      // ===== IMAGE =====
      if (item.type === "image") {
        var img = document.createElement("img");

        img.onload = function() {
          crossfade();

          timer = setTimeout(function(){
            playAt(nextIndex, 0, playlist[nextIndex].duration);
          }, Math.max(250, remaining * 1000));
        };

        img.onerror = function() {
          showError("IMAGE FAILED:\n" + item.url + "\n\nCheck filename EXACTLY (case-sensitive).");
          timer = setTimeout(function(){
            playAt(nextIndex, 0, playlist[nextIndex].duration);
          }, 1200);
        };

        img.src = BASE + item.url;   // absolute path for TB1 reliability
        back.appendChild(img);
        return;
      }

      // ===== VIDEO =====
      if (item.type === "video") {
        var vid = document.createElement("video");
        vid.muted = true;
        vid.playsInline = true;
        vid.autoplay = false;
        vid.preload = "auto";

        // Safety timer (TB1 sometimes never fires onended)
        safety = setTimeout(function(){
          playAt(nextIndex, 0, playlist[nextIndex].duration);
        }, Math.max(750, remaining * 1000 + 500));

        vid.onloadedmetadata = function() {
          // seek to synced spot
          var startAt = elapsed;
          if (startAt < 0) startAt = 0;
          if (startAt > item.duration - 0.1) startAt = item.duration - 0.1;

          try { vid.currentTime = startAt; } catch(e){}

          // start playing
          try {
            var p = vid.play();
            // ignore promise (TB1 may not support)
          } catch(e){}

          crossfade();

          timer = setTimeout(function(){
            playAt(nextIndex, 0, playlist[nextIndex].duration);
          }, Math.max(250, remaining * 1000));
        };

        vid.onerror = function() {
          showError("VIDEO FAILED:\n" + item.url + "\n\nIf it’s laggy or fails on TB1:\nRe-encode MP4 to H.264, 30fps, ~4Mbps.");
          timer = setTimeout(function(){
            playAt(nextIndex, 0, playlist[nextIndex].duration);
          }, 1200);
        };

        vid.src = BASE + item.url;  // absolute path
        back.appendChild(vid);
        return;
      }

      // Unknown type
      showError("Unknown item type: " + item.type);
      timer = setTimeout(function(){
        playAt(nextIndex, 0, playlist[nextIndex].duration);
      }, 1200);
    }

    // START SYNCED
    var s = syncedPosition();
    playAt(s.index, s.elapsed, s.remaining);
  </script>
</body>
</html>
